<!doctype html>
<!--suppress HtmlUnknownTarget, HtmlRequiredAltAttribute, XmlDeprecatedElement, CheckImageSize -->
<html lang="en">

<head>
    <title>Obfs4 Illustrated</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="title" content="The Illustrated Obfs4 Connection" />
    <meta name="description" content="Every byte of a Obfs4 connection explained and reproduced" />
    <link rel="stylesheet" href="frombootstrap.css?b1" />
    <link rel="stylesheet" href="illustrated.css?b1" />
    <script src="illustrated.js?b1"></script>

    <!-- favicons -->
    <link rel="apple-touch-icon" sizes="152x152" href="favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/site.webmanifest">
    <link rel="mask-icon" href="favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
</head>

<body class="illustrated">
    <div class="header">
        <a class="this-page" href="index.html">Obfs4</a>
        <a href="obfs4p.html">Obfs4+</a>
        <!--a href="#">O5</a-->
        <!--a href="#">O7</a-->
    </div>
    <h1>The Illustrated Obfs4 Connection</h1>
    <div class="container">

        <h3>Every byte explained and reproduced</h3>

        <!-- explainer paragraph -->
        <div class="outerblock">
            <p>
                In this demonstration a client connects to a server,
                negotiates an Obfs4 session, sends 1450 bytes of "lorem ipsum"
                text, receives the same text reversed, and then terminates the
                session. Click below to begin exploring.
            </p>
            <p class="iatswitch iat-disabled iat-shown">
                Disabled
            </p>
            <p class="iatswitch iat-enabled iat-hidden">
                Enabled
            </p>
            <p class="iatswitch iat-paranoid iat-hidden">
                Paranoid
            </p>
        </div>

        <!-- Buttons! -->
        <div class="rec-outer">
            <div class="rec-horiz", style="overflow-y: hidden;">
                <!-- Open All -->
                <div class="open-close-all" style="float:left; margin-top: 5px;">
                    <button id="openCloseAll" class="annotate-toggle" data-lbl-state="open" data-lbl-toggle="Close All"
                        onclick="ill.openCloseAll(this, event)">Open All</button>
                </div>

                <!-- Expand / Collapse Padding -->
                <div class="expand-collapse-pad" style="float:left; margin-top: 5px; margin-left: 10px;">
                    <button id="expandCollapsePadding" class="annotate-toggle" data-lbl-state="expand" data-lbl-toggle="Collapse Padding"
                        onclick="ill.expandCollapsePadding(this, event)">Expand Padding</button>
                </div>

                <!-- IAT Mode Switch -->
                <div class="iat-strategies" style="float: right;margin-top: 5px;margin-left: 10px;">
                    <input type="radio" name="iat-strategy" value="disabled" id="disabled"  onclick="ill.toggleIATDisplayed(this, event)" />
                    <label for="disabled">
                        Disabled
                    </label>

                    <input type="radio" name="iat-strategy" value="enabled" id="enabled" onclick="ill.toggleIATDisplayed(this, event)" />
                    <label for="enabled">
                        Enabled
                    </label>

                    <input type="radio" name="iat-strategy" value="paranoid" id="paranoid"  onclick="ill.toggleIATDisplayed(this, event)" />
                    <label for="paranoid">
                        Paranoid
                    </label>
                </div>
                <h4 style="float: right">IAT Mode
                    <sup title="Inter-Arrival Traits for packet size and timing distribution.
Disabled = pass-though
Enabled = pad to ~MTU,
Paranoid = throw performance out the window and sample
    length and time distributions on every write.">&#9432;</sup>:
                </h4>
            </div>
        </div>

        <!-- Server Identity Key & ID Generation -->
        <div class="rec-outer">
            <div class="calculation server">
                <div class="rec-label">Server Identity Key & ID Generation</div>
                <img class="illustration" src="images/key4.png" width="106" height="250" />
                <div class="rec-explanation">
                    <p>The server generates a private/public "identity" key-pair
                    for long term use. This allows the server to distribute its
                    long term public key out of band so that a client can
                    perform a key exchange to obfuscate it's first message. Key
                    exchange is a technique where two parties can agree on the
                    same number without an eavesdropper being able to tell what
                    it is.
                    <p>
                        An explanation of the key exchange can be found on
                        <a href="https://x25519.xargs.org/">https://x25519.xargs.org</a>,
                        but doesn't need to be understood in depth for the rest
                        of this page.
                    <p>
                        The private key is chosen by selecting an integer between
                        0 and 2<sup>256</sup>-1. The server does this by generating 32
                        bytes (256 bits) of random data. The
                        <a href="files/server-ephemeral-private.key" download="server-ephemeral-private.key">private
                            key</a>
                        selected is:

                    <pre class="ind2"><tt class="longboi"
    >909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeaf</tt></pre>

                    The <a href="files/server-ephemeral-public.key" download="server-ephemeral-public.key">public
                        key</a>
                    is created from the private key as explained on <a
                        href="https://x25519.xargs.org/">https://x25519.xargs.org</a>.
                    The public key calculated is:

                    <pre class="ind2"><tt class="longboi"
    >9fd7ad6dcff4298dd3f96d5b1b2af910a0535b1488d7f8fabb349a982880b615</tt></pre>

                    The public key calculation can be confirmed at the command line:
                    <codesample>
                        <pre><code>### requires openssl 1.1.0 or higher
$ openssl pkey -noout -text &lt; server-ephemeral-private.key

X25519 Private-Key:
priv:
    90:91:92:93:94:95:96:97:98:99:9a:9b:9c:9d:9e:
    9f:a0:a1:a2:a3:a4:a5:a6:a7:a8:a9:aa:ab:ac:ad:
    ae:af
pub:
    9f:d7:ad:6d:cf:f4:29:8d:d3:f9:6d:5b:1b:2a:f9:
    10:a0:53:5b:14:88:d7:f8:fa:bb:34:9a:98:28:80:
    b6:15
</code></pre>
                    </codesample>
                    <p>The "Node ID" is a random 20-byte long term value chosen to
                    identify this specific obfs4 server.

                    <p>
                        The Node ID is chosen by selecting an integer between
                        0 and 2<sup>160</sup>-1. The server does this by generating 20
                        bytes (160 bits) of random data. The Node ID
                        selected is:
                    <pre class="ind2"><tt class="longboi"
                        >9fd7ad6dcff4298dd3f96d5b1b2af910a0535b14</tt></pre>
                </div>
            </div>
        </div>

        <!-- Client Key Exchange Generation -->
        <div class="rec-outer">
            <div class="calculation client">
                <div class="rec-label">Client Key Exchange Generation</div>
                <img class="illustration" src="images/key6.png" width="105" height="250" />
                <div class="rec-explanation">
                    <p>The client begins by generating a private/public keypair
                        for key exchange. Key exchange is a technique
                        where two parties can agree on the same number without
                        an eavesdropper being able to tell what the number is.
                    <p>
                        An explanation of the key exchange can be found on
                        <a href="https://x25519.xargs.org/">https://x25519.xargs.org</a>,
                        but doesn't need to be understood in depth for the rest
                        of this page.
                    <p>
                        The private key is chosen by selecting an integer between
                        0 and 2<sup>256</sup>-1. The client does this by generating 32
                        bytes (256 bits) of random data. The
                        <a href="files/client-ephemeral-private.key" download="client-ephemeral-private.key">private
                            key</a>
                        selected is:

                    <pre class="ind2"><tt class="longboi"
    >202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f</tt></pre>

                    The <a href="files/client-ephemeral-public.key" download="client-ephemeral-public.key">public
                        key</a>
                    is created from the private key as explained on the <a href="https://x25519.xargs.org/">X25519
                        site</a>.
                    The public key calculated is:

                    <pre class="ind2"><tt class="longboi"
    >358072d6365880d1aeea329adf9121383851ed21a28e3b75e965d0d2cd166254</tt></pre>

                    The public key calculation can be confirmed at the command line:
                    <codesample>
                        <pre><code>### requires openssl 1.1.0 or higher
$ openssl pkey -noout -text &lt; client-ephemeral-private.key

X25519 Private-Key:
priv:
    20:21:22:23:24:25:26:27:28:29:2a:2b:2c:2d:2e:
    2f:30:31:32:33:34:35:36:37:38:39:3a:3b:3c:3d:
    3e:3f
pub:
    35:80:72:d6:36:58:80:d1:ae:ea:32:9a:df:91:21:
    38:38:51:ed:21:a2:8e:3b:75:e9:65:d0:d2:cd:16:
    62:54
</code></pre>
                    </codesample>
                    <p>
                        One of the central design goals of Obfs4 is to make
                        every packet entirely indistinguishable from uniform
                        random. In order to achieve this we need a way of
                        encoding the public key in a way that doesn't retain
                        any of the structure or computational distinguishers.
                        To do so we use the <a href="https://elligator.org/">Elligator2</a>
                        encoding scheme. The calculated Elligator2 "Representative" is:

                    <pre class="ind2"><tt class="longboi"
                        >f4d05df78ec6f67ac104319963cac09764ba890f892528169dcbbfdb1666a7bd</tt></pre>
                </div>
            </div>
        </div>

        <!-- Client Handshake -->
        <div class="rec-outer">
            <div class="record client">
                <div class="rec-label">Client Handshake</div>
                <img class="illustration" src="images/key1.png" width="135" height="250" />
                <div class="rec-explanation">
                    The session begins with the client saying "Hello".
                    The client provides information including the following:
                    <ul>
                        <li>client ephemeral session public key representative
                        <li>padding of random length between 4096 and 8192 bytes.
                        <li>mark indicating that the client knows the servers Node ID
                        <li>MAC value ensuring that the contents of the packet have not been modified.
                    </ul>
                    While this will not typically fit in a single TCP packet, for the sake of this demonstration
                    it will be presented as a single packet. Also, as the elligator2 representative
                    is a deterministic transformation of the public key, session ephemeral keys should
                    never be re-used, or the client handshake messages will begin with identical byte
                    sequences.
                </div>
                <span class="record-data">
                    <span class="string">
                        <span class="label">Elligator2 Encoded Public Representative</span>
                        <span class="bytes">
                            f4 d0 5d f7 8e c6 f6 7a c1 04 31 99 63 ca c0 97 64 ba 89 0f 89 25 28 16 9d cb bf db 16 66 a7 bd
                        </span>
                        <div class="explanation">
                            Each handshake message starts with the client's x255519 public key encoded using
                            the Elligator2 encoding scheme.
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Padding</span>
                        <span class="bytes padding-short">
                            da 88 ..(4092B).. e4 c3
                        </span>
                        <span class="bytes padding-long" style="display: hide;">
                            da 88 54 2c e5 81 71 69 6e f7 01 74 c6 47 fb 7c b9 81 b7 b5 92 9e 29 b3 0d 00 95 d3 64 bf 49 3a c3 f2 be bf 20 5a 2d 21 e1 87 52 2a 5e fc 1d 1c 62 32 bc 03 63 75 db 43 65 4a 3b a8 a2 76 9a 65 79 75 37 e9 81 53 aa 92 d5 50 7c 78 e0 90 6d 69 aa 8e 50 f9 1b ce fc 33 2d fd bd be 46 4c 2a 20 fc 76 95 e4 5b 75 14 23 53 e0 d0 7c cb 2c d5 a0 ac c6 4b 43 ff b8 3d 4f ab c0 da 10 d9 2d cc 5e c3 43 f9 30 f0 a7 8a 34 b0 fa 6f 63 7d 82 0b 71 43 6d ed d7 5c d5 37 da 8a 9a b5 f9 45 3a c4 a5 2f 5c 15 37 4d 48 a7 81 b7 ca 02 05 08 d4 dd 73 bd 66 9a 1d b2 02 cf 50 b5 ab a3 06 7a a1 be 1b cd a5 20 2a dc 59 b4 ca 4e 43 6f 78 cb 57 9f 27 62 6c e1 6a 46 b6 c3 8c 20 9a 5b f0 b9 a8 39 90 fa 71 aa 22 c4 10 76 5b 1a 8d 67 0d 1e 31 cb 16 48 7d 21 de 3a 51 fe 3a 3c 49 ad b9 84 7d a6 69 f0 3b 08 c6 b5 f3 0f 90 48 b8 ac 4e bf e3 a1 14 fa 46 cb c3 9e b3 73 8a c3 eb 5e 17 8d 87 75 66 54 f2 37 9f bf d8 52 4f 4d d7 cb 26 0f 5a ce 56 50 08 28 68 de 30 b9 3d 5d 6a 92 0b bc 1b 0f 53 a8 03 8a 55 82 6f 23 a0 ce d3 ca 56 62 52 53 ff ac f4 5a b8 93 f1 11 db 1f 6f 76 63 c6 e4 d5 8c 37 c4 15 66 40 3d ce 98 a0 fa 22 1d 2a 81 1b b0 62 c8 b1 ce 2d d0 a8 b9 48 f8 67 0c 76 96 42 78 23 45 44 63 51 bb dc cb eb b8 28 39 70 6d e5 7f c6 35 c6 75 05 40 e6 1b 0f 7a e6 4f 13 9f b3 96 c2 ca 2e 7a 31 e1 e5 39 d5 70 a3 b6 4c 7f 79 04 70 63 ee d1 26 93 ac 8d 95 fb c3 fb da 80 0c 7e 42 84 c8 d3 ac cf c6 17 af e0 29 3d 1c 5d e2 0f b2 9f 5f 33 92 36 08 97 34 1d 63 5c e0 6a 66 d0 d1 c7 fb 40 d0 ff 81 89 d1 f2 44 1e 04 74 a4 12 bb 22 09 0a 8d dc 90 a7 bf 30 09 70 a5 0f 44 11 00 2a 91 4c d4 70 68 b7 62 e5 cd ab d6 f1 0c 3f 54 ac 80 5c d1 a6 16 2d 98 17 a3 e5 5b 4c cc 31 9f 33 28 28 c3 84 35 06 88 a4 48 8f e4 60 39 7b 5c c8 09 db 56 75 68 74 16 c8 18 38 aa b5 09 bb 22 0f 55 ad 98 2a 3e 56 f7 60 99 52 df f4 cb 57 00 89 af db a3 4b 7e 7c e0 37 9b b3 cc 0e 18 d7 37 4d 95 66 15 76 0f 6e eb dd 68 8b 91 25 be c0 f0 05 54 69 8f 18 8b 5d c2 1a 82 03 db 97 8a 62 d7 38 cc 5b da c8 21 03 81 b6 0a 30 78 dd 53 44 41 28 32 8e 15 f7 92 d1 3b 3c 90 cc e2 e5 cc 71 d0 c3 bb 54 45 71 50 6f e1 3c b6 db e5 cc 9c 3d 4d b6 07 f1 49 e9 db a6 b0 2a ab 96 4c ab a0 72 a8 8d 26 4d 58 a3 d3 60 7b e1 d6 c5 d1 5d 7c 1d 42 ed 30 9a 60 dd b8 90 0b 18 5f f6 f9 ec 7f e3 6e cf 70 fd 62 d6 87 5e e7 df eb 84 42 74 88 cd 12 48 ad 0b 18 16 e3 a1 e8 20 19 79 57 f3 64 2b cb 30 6b 89 ab 0b 14 67 37 61 9a 3e 96 45 de 6a 7b b5 78 78 18 02 9b 4e e0 93 48 34 ce 2c b2 cd 6f 4c 6b 65 10 47 cd b5 94 27 27 f2 d6 76 a5 da 7d df 7c d1 88 96 1d e2 08 29 dc 45 5e b8 09 f2 e5 b6 b6 37 f4 d6 95 99 d4 86 02 0d 7f 7e fa 6e e7 52 05 72 47 28 d9 5a bc 5f f7 d8 d7 5c 2d 13 90 cf 86 a9 07 e4 50 d7 5f ce c2 39 1f 1a 45 83 2d bb 3f 23 d8 06 e8 f3 ef 60 54 99 32 43 f9 27 78 98 02 c4 2c 70 db 60 e5 af 0e f0 f9 48 3c bd a4 4a eb 69 e9 3e 16 c9 2c 30 8b af ac 1d 90 95 75 eb 7f 7f bd a4 2c a0 ce 88 77 d3 cd 88 f6 0c a4 1c e9 39 64 38 cc 16 9e 77 29 04 62 8e 13 ea 8d 34 f7 de 02 7d 93 37 a0 9f 4b 9d f0 18 c4 dd cd 73 31 c6 1c 6f be e0 2e e1 15 8c 71 04 73 f1 eb dc e1 28 61 1d f6 6a 5f 8d ff 7e a3 70 e6 e4 d1 f0 56 a2 1e c6 05 fb 10 1a 34 e3 e7 24 1a ee 53 bb 3d 9a b7 75 80 f6 9b 1e 92 d0 6a f6 a7 a5 17 7e db 7c 92 d9 93 45 e4 f4 39 33 a5 f9 22 b6 16 82 0b ac 21 dc 23 9f 1a ca 16 a7 bd ba ec a6 32 f1 20 b4 7b c6 79 55 85 30 e5 7c ba ae d5 bf 4c 9d 7c c2 36 45 14 4e a6 64 44 f8 f6 c4 8a d8 1e f6 13 df 35 03 f4 ee d3 28 ab 52 a4 06 cf f0 e0 0a 9b 9c 45 93 7f f1 79 13 76 49 2f 1e 02 7c a5 95 8f 17 93 2d 02 36 9b 63 2e f2 66 83 2a 4a 2e 1e 90 8d 45 ea ff ed bc c7 07 04 d5 0c 39 15 0b ac 88 9c 15 27 32 dc a3 7b 87 50 7b 06 af f2 36 38 1b 93 e3 7c 6c e4 5a be aa e8 ab 05 95 d8 99 d5 b0 6c 40 ad 23 91 07 15 e4 30 4d 4a 38 9d 2e 2f 06 e1 a2 42 9f 24 78 35 b1 e5 65 65 39 48 c2 ab 8f 54 f8 54 78 dd 63 ec e0 4a 13 d8 75 de 91 3f fb d7 a9 9f 70 13 5f f5 7c d3 9d ca 76 9c 81 14 d9 34 ee cd 7a 3f df ee 59 c4 e2 4d 5b 88 d5 2e f3 8e 88 dd f1 3e 6a c4 39 cb 7d d9 e6 97 85 9a b4 08 b4 df ed 66 fd 02 64 86 c9 3e 7c 8b db 70 93 6b 40 74 75 06 b4 a4 7e 10 8b 62 2b 35 cc 79 66 9e ac 94 1c 4f 5d 60 a4 f6 b1 e5 86 3b 49 7c 81 73 02 6a 6c c7 eb 86 d5 dc a9 e1 bf 84 0b 38 d7 cf aa d0 1d eb 51 2b 0d 58 38 e4 8b 15 9c a5 df 7b 57 5d 4a 95 d6 00 ea a8 28 d0 f9 68 9d de 95 61 7b 50 8c 4e 8f 68 d7 1e e4 db 85 9e 6a 9d 19 4d 70 30 6e 10 3f 55 04 66 10 dd e9 5f a0 eb 79 a9 77 ad 42 27 92 3a 98 f5 d2 6d ff 1f 85 59 02 3c 97 8e 8f 80 d2 9d ff 6c 9a 72 e5 e1 fc 4a 0d 30 d3 bd 21 c2 f4 25 a2 75 5e 07 0d cc 7d 8a 4f 16 eb aa c6 7a 5f 23 90 c3 39 9b f1 1c 17 8b fd 04 64 0b a8 93 5a 00 e6 59 6b 38 89 d3 c2 47 3d cb 7a 22 0f 59 e0 ba 97 13 26 d9 f8 d8 58 bd cc 0c dc 9c 92 ac de f6 10 18 4c 56 ec 2a d0 98 e5 0e 02 26 11 9b ad 0f fd 61 d8 ba a0 19 f1 67 73 53 92 bb 48 f6 d5 bc f4 0d e7 1a bd 53 f4 57 c1 2d c6 55 00 ec d7 46 19 9b a0 0e eb e7 a7 7d f8 5c 81 9b 25 1c 6d 78 c4 fc 35 e2 68 a1 bf c0 1b 94 60 09 11 d2 dc e2 af 06 24 7f d1 4f ba 65 37 e0 7e 0f 01 3a 59 72 c4 2b 7d 4d 6d 8b 5c ba cc 41 2f 9c df b7 7b 0f f9 3c 27 1e 49 5e 50 4d 3b 9d 0c 8c 96 5b cd ef aa eb dd a9 27 1b 1b 5f 34 9a e6 91 a5 75 43 9a e3 32 8b da b5 1d 08 ab 41 db fb 08 11 b7 8d 20 22 ce ef 1f 85 b6 8b a3 3f 86 45 06 76 5f c6 8b 1f 29 00 dd 0a 81 6a 99 0f e4 90 bc 37 61 30 4e fb a9 2d f2 16 67 76 c7 a0 4d b7 d0 8f 8f 38 ff 9e 24 81 f3 f0 5e 9a c4 1f 0d 70 d9 f5 17 bc 1b 2e f9 e9 24 35 34 51 a0 93 41 99 eb 0b 00 f5 fd 4a e3 df 76 c5 d7 92 07 37 9b b3 c5 65 c1 62 15 94 a1 16 45 88 f4 c3 18 28 91 c0 50 c9 06 b6 a0 fe 67 13 92 41 12 e6 41 b1 1c e6 c6 a5 06 d5 a8 e2 c8 15 a6 53 f6 42 ca 6c 01 43 83 31 b2 92 97 ee dc 1d 82 50 9f 92 db 11 12 61 24 0b 9c 24 f1 04 eb 73 a2 3f 5d 04 72 ea d5 23 93 f2 d7 da bc 0f a1 95 02 93 0b 75 3f cc c3 55 5b b9 3c d5 e9 e1 9a d6 e6 92 32 1e 30 1f 1a 95 f9 7b 80 f3 40 86 2d 10 68 29 3c 47 dc 93 40 fd 28 8a 1d 79 e8 88 6e 25 0b 13 6a 1b 63 35 b5 b8 eb bd 70 7d 20 66 a5 3b 3a 81 18 52 81 bb ea e7 80 5d ca da 9f a9 1b a5 56 e6 55 82 15 d8 a3 aa a0 da c7 ac 7a 8d 2d 28 1a de ac 11 22 15 ca a1 25 91 13 4f 75 af c9 f5 10 2f 1c 6c 4d 6c de 17 53 83 ff c0 eb e5 60 b4 e1 4a 4c d5 b9 68 83 b0 fb 75 d0 e1 29 c2 d1 75 0c c1 d1 96 cf 1a 2e 35 c2 fc 82 01 7e d8 83 e0 08 d7 dc a2 46 9c 82 bc da af 3b 42 9e 1d 97 41 a8 f5 0d 18 a8 96 34 0f a1 4f 33 a0 ad 6c 56 25 ae 64 a3 51 b0 12 df c1 cb cd a7 7a b8 d6 92 e9 7f 56 7d 83 3f c8 53 16 73 eb fd 6f 78 c9 91 05 3c 51 a4 b1 28 b4 ae a7 ee ce b6 3d 2f ea dc b4 2e f9 06 5d 73 5d 33 12 ce 1b ed 8d ec 23 5f 4b c3 97 31 c7 c5 d6 8f fa b9 38 15 43 c3 b5 58 10 a3 2e fd c4 5d cc c4 42 59 f3 fe 2d b8 69 72 43 86 b4 6d cc ae b2 3d 9f 1b 21 0c a2 23 c7 61 1e a9 59 7a 8e e3 6c 9d 1e 2d 1d 0d fb f3 37 0c b4 be da cc 38 cd 69 4b a2 0b 69 c4 0d b1 82 c1 5c 5f 7f c6 9a 37 22 df 5b d8 04 91 93 28 4f db 22 06 ba fc f1 f2 71 40 55 f5 64 3a ce 2c 6f 9d 2b bc c6 dd 95 0b 01 10 98 19 3a 9b 3f da 0f d8 c0 41 40 7e be 6a 8b bd 02 a6 92 d5 a6 b2 57 dc 22 59 43 00 53 09 58 a6 e6 5c 52 90 65 d5 36 26 d0 c6 81 5c 57 b8 7a 20 45 f9 1d 83 72 bd 63 46 e1 8c 33 d0 df 98 3d 2b bb 99 34 e5 e2 29 4c d4 c1 73 20 8a 77 e1 d0 33 fb 9c b1 82 d0 87 7c ea c9 fc 24 e9 82 c7 b9 42 a6 2d fa 1b e2 62 d7 eb c3 cf 71 04 52 e7 c2 d9 81 08 9c d4 b6 d6 0a 4d 24 bd 45 83 19 65 10 2c 8f b3 6e f8 80 b5 17 98 b9 68 41 0b 7b 9e 72 b9 87 d2 ea c0 5e fa 48 07 9e 12 af ee 42 b9 88 08 13 b4 42 54 8b dc 24 55 b9 64 b7 60 94 db 8a 9a 7f 9a 86 01 b3 21 34 26 c1 03 87 2e 53 9b 8a 85 a3 95 42 06 aa c7 57 77 e4 e5 bf e1 3c d8 5d 7d 96 22 7d e6 2b cb 74 1b 70 77 ed 4c 69 3b 6b 1e 5a 2a 67 48 06 9e 99 7c 8a 18 da 4e fa 74 e3 53 d2 5e 84 15 51 35 77 70 f4 b9 0c 58 b0 0f 93 4a 28 55 28 ae 11 b1 2c f9 c6 10 57 58 e0 e3 a1 4c 3a b4 c2 81 03 d5 a0 72 db a2 cc 36 d0 66 48 8e 6a b8 c5 b9 d9 db 4d f6 25 a5 33 5c 1f 86 10 54 15 5c b3 07 9e 6d 27 8b 25 7d a0 a3 10 19 94 17 13 2b 61 f2 bc 6c d7 28 19 04 c1 61 ab d8 5a 31 e9 9e 6a 52 4e da 39 d2 15 85 a2 f8 8f 6c fc 4b d2 ca b6 2b 15 b6 92 ee cc b4 f8 54 5d 57 51 28 58 31 78 0a bc f7 2e 3d 46 6a 44 c2 9d ee a4 ae 92 9a a4 dc ec 2e 6c 9f 72 82 e7 0d bc 77 00 85 6f 2e 0d 4f 8e 74 80 05 f9 c3 62 04 1e 98 22 b3 bc d3 e7 6c fa c5 84 56 b2 fe aa aa 06 91 53 93 c2 2e ac 6e 41 6d 97 e3 7a 0c 1c 2f 1e a8 31 50 ca 10 bb 8d fb 08 43 0e 2b 9f 3c b1 36 13 da 00 73 ac a1 7b b2 b4 8d f3 10 db ed 80 61 de 8a f9 4a b3 3c 2c 76 05 87 b6 ae 76 5e a7 b2 f6 fd df 73 b0 e2 0f 33 dd 32 49 d7 03 c4 40 a4 72 56 8b 3e 22 8f c6 fb 54 32 5d f3 09 00 83 38 fc bc 1e 16 df 17 e6 5a d1 8f 68 3a aa c3 2c 9c af 6d cf 84 19 5b 91 d6 40 cd d4 67 32 4f 65 b5 22 99 23 5c 81 6e 9e f9 82 71 7e 83 11 31 cd 2a 0c e4 d6 9d 74 c7 b0 03 3a c2 96 10 fa 49 83 c4 b2 c7 19 88 5b 35 67 21 41 28 5d 58 06 f7 ff 5e 27 7b c4 aa 82 ba 75 f6 1e d7 5f a1 88 cb e6 26 ed 65 ca 0d 21 8f 31 69 5e 14 cb 77 98 4e 3f 71 f2 bb ac fa 17 3b 0f 6d 7b 7a 03 74 49 60 a8 3e 58 dd aa 92 6d 66 09 a2 fe 4b 27 30 30 48 98 66 73 bd 6d 68 f2 1c f0 84 97 a3 10 de 86 2d 26 06 61 8c fe 23 e1 98 90 00 26 e7 88 86 0a 6c 63 2f 40 7c 45 ff c4 05 12 4b 52 30 e9 6f 20 80 d6 c7 c4 cf d2 98 2e d6 6a fa 91 e9 90 63 ce 21 ba ea 70 03 40 32 62 53 04 a7 4e 35 7c b5 4b 47 27 b4 83 94 61 17 10 75 09 34 86 5b fa 1d 34 68 df 5b ae 21 09 cb 84 12 fd 96 54 58 87 52 aa ad 00 df d7 07 45 2e 4e 4c 78 8e 16 f6 93 6f 4d 7a 9e 01 01 4b ba 30 30 ea 9c 98 f6 7f 20 f9 ae 07 63 6f 42 dc 06 2b ec 51 be f0 d4 8d 24 ca 11 45 7e a6 60 e9 09 f6 49 10 a4 59 10 1d f8 d2 b9 ee bd e4 11 8f e3 17 eb ae 0a ae 28 83 b5 96 a5 d0 87 13 df 81 db 1f 52 8f 57 c5 e7 42 ec 2a 65 ab 8f 98 c8 f5 fd ee d6 db 61 20 0b 41 27 9a c1 94 f5 8b da 1d 52 d0 bb 37 e2 39 79 54 35 33 8b 24 15 97 cb c0 f1 75 b8 18 d8 f6 69 b8 3c 49 7e 8c e0 2f bc 04 79 58 76 90 8a ee ac 52 87 f1 39 ef 21 9b 78 7d a2 60 c6 32 33 9c 2d 5f 2f 0d 0a f4 e0 c1 7d d7 83 1f 36 ee 98 3f 4c 71 b5 ee 95 66 4e 7b 61 8c e7 c8 ca de 87 2f 66 f1 06 31 62 8b b9 7e 3d 22 c4 c6 58 9e 3e ec a3 f0 3b ea b6 ce 36 c8 ab 81 1e 8a dd 28 cd d6 33 1f d4 30 b0 4c e5 c4 07 57 ab ec 3b 66 61 e3 34 3f ee 46 81 80 5b 90 89 49 d0 49 19 f2 b1 20 1a 62 5c 2d 6c 42 6f 31 a2 d1 60 b3 25 c4 db c8 69 2f 21 62 95 4c 4c 4b 6d 3f ea 74 3a 02 1c 3d 40 39 7a e0 30 6c 14 02 67 50 04 90 d1 b7 2c fc ba d5 15 d8 e6 4c dc 89 1d 08 2a 18 07 9e a7 a6 a0 a9 05 d3 ea 02 0c ae c1 1e cf 3e 85 7c 04 cd 31 a3 b0 67 78 b3 c2 66 17 d1 ea e8 a7 57 a4 75 65 9a bd 01 b7 db 2b 73 d0 37 ed 3b ee 36 89 3f 01 68 97 9b 89 83 25 b0 56 10 1d bb 76 1a 16 9e 3a a5 40 6a 08 de a9 73 cf 8b c3 77 f9 72 7d 74 5b b6 62 df ef c9 59 01 d8 c4 14 71 ad e3 00 4c a5 7c 87 d4 b7 78 f0 c2 00 04 26 55 55 cb be 15 0a 60 21 5a 4c 1b 52 c0 97 6d 49 9f 4b 2a c6 ab 52 74 bb e5 ef e1 47 f6 ee ac 49 05 27 d6 e2 d3 1e a8 c3 49 36 6c d4 a4 c7 f4 ed d6 ba 25 cd 19 e4 6f c8 31 c1 58 9e 90 2b 77 66 e6 08 1f f7 09 fc 7d a6 f6 13 49 38 aa 58 aa b3 6c 01 1d a6 66 29 c8 f9 32 02 35 40 f7 7a 99 de f4 6c d6 f4 93 39 e2 98 76 23 d3 81 4b 71 72 e4 19 c0 56 ff 31 47 39 89 71 92 2b 96 44 11 d2 0e 4f 77 c2 09 4c b0 4b bb 8c c7 eb ea 70 e8 64 cb f7 80 80 a7 00 1a bc c7 3a da 64 b9 28 2e f8 3e 02 03 20 5e dd 4f a2 23 4b 37 ac 3b 1a 68 7e c7 f2 b6 91 83 17 9a 45 87 5b 7b e8 85 00 ca 7e 23 88 02 a4 8f 88 37 a9 c4 ed 55 20 a1 7d cf 95 97 92 92 93 19 63 ab e1 ac 4e 7b 87 ca ec a3 0d 6e dc 90 76 16 1d 8d 67 04 b9 23 b5 02 e0 4d ff 87 06 2b f0 7f 51 58 91 94 38 9c 54 45 0f 82 0d 54 68 f7 39 f1 cf 0c f2 e0 c7 3f b6 50 79 19 1a 66 e7 5d e4 a7 25 a2 a7 ef 14 d9 7e 10 3f 8d 25 ab 4c 76 9e 83 d8 f7 d1 37 87 d9 70 3b 1e 02 2c 96 dd 87 e9 c5 57 84 de ab 44 d7 19 8d a8 29 55 d6 32 4c 16 9e 85 38 a9 94 77 92 f3 bd 7a e8 24 fa 3d c4 d6 89 01 77 99 7f a0 ea db 03 13 45 fe 40 e4 6c 23 59 35 32 f8 5b 0d 82 9e 94 0e 21 75 05 23 e1 d6 85 47 47 cf f3 ae f5 7c 4c ad bf 10 0c e2 a8 d0 06 cc 20 6d 98 3b 60 f7 71 a2 11 a8 76 1c 51 ef 99 8c aa b9 6d d9 88 45 22 fd d9 6f 97 53 53 b0 7e a8 12 22 4b 49 6a 5a 02 ea ee a6 35 17 9d 80 de 8d a3 2e ba e7 ae a4 b9 5b 34 92 13 72 b0 3e 0c e9 2f 49 92 d8 18 d0 a6 ec 33 e5 1a bc d0 3e 39 77 ed 46 38 f1 ca b7 99 c2 93 94 e6 e9 09 97 d3 7e eb fa f0 20 ab 30 e8 86 81 84 93 4f c6 19 06 7d e2 8b b9 4b 1e b7 da 0b 62 41 e9 46 a4 21 f2 34 12 91 99 65 b8 b5 5e 5a 13 bf 17 c2 3c 36 c5 c3 db 9f 78 a9 06 87 84 a3 ae 2a 90 30 d6 f3 b6 08 a6 9a 47 4f 77 02 b0 7a 87 cd c8 97 53 99 5b d3 75 a2 02 12 b8 2a bd 9f 98 b5 ca a9 c3 c3 f8 31 87 5a 26 51 2b 2d d6 7f 09 ac 71 f9 8e 23 60 6e fd 67 85 49 af 94 0a 4c a3 73 af 32 32 af 57 86 7b 22 9e b3 90 46 0f 5c bf 90 17 b1 25 b2 2d dd b9 a7 07 61 de e4 c3
                        </span>
                        <div class="explanation">
                            In obfs4 the client pads the handshake message with random bytes to a length between
                            4096 and 8192 bytes. This padding is used to make the handshake message a non-uniform
                            length such that the size of the first packet would be a strong indication of the
                            specific protocol being used.
                            <ul>
                                <li><tt>da 88 ... e4 c3</tt> - bytes drawn form prng source.
                            </ul>
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Steganographic Mark</span>
                        <span class="bytes">
                            13 02 13 03 13 01 00 ff 13 02 13 03 13 01 00 ff
                        </span>
                        <div class="explanation">
                            As the obfs4 handshake is (ideally) indistinguishable from uniform random bytes,
                            the client includes a steganographic mark in the handshake message to securely
                            indicate that it wishes to establish a connection. The mark is an HMAC that
                            uses the server's public key and node ID as hte key and
                            the client's ephemeral public key as the message. While the HMAC-SHA256 would
                            usually result in 32 bytes, only the first 16 bytes are used for the mark.

                            <p></br>&emsp;<tt>HMAC-SHA256-128(ServerPubkey | NodeID, REPR)</tt>

                            <p>where:
                                <ul>
                                    <li><tt>ServerPubkey</tt> - The obfs4 servers 32 byte public x25519 identity key
                                    <li><tt>NodeID</tt> - The obfs4 servers 20 byte identifier value
                                    <li><tt>REPR</tt> - The clients Elligator2 encoded public key representative
                                </ul>
    

                            <p>Python sample code to produce the hmac value:

                            <pre><code>import hmac
import hashlib

server_pubkey = b'\x9f\xd7\xad\x6d\xcf\xf4\x29\x8d\xd3\xf9\x6d\x5b\x1b\x2a\xf9\x10\xa0\x53\x5b\x14\x88\xd7\xf8\xfa\xbb\x34\x9a\x98\x28\x80\xb6\x15'
node_id = b''
hmac_key = server_pubkey + node_id
msg = b''
h = hmac.new( hmac_key, msg, hashlib.sha256 )
digest = h.hexdigest()
print( digest[:len(digest)/2] )
</code></pre>
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Message Authentication</span>
                        <span class="bytes">
                            00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f
                        </span>
                        <div class="explanation">
                            In order to ensure that the contents of the handshake message have not been
                            tampered with in transit, the client includes a second HMAC value using the same
                            key as the steganographic mark, but covering the contents of the entire handshake
                            message.

                            Again the HMAC-SHA256 value is truncated to 16 bytes.

                            <p> If we consider the handshake so far to be <tt>[ REPR | PAD | MARK ]</tt> where:
                            <ul>
                                <li><tt>REPR</tt> - The clients Elligator2 encoded public key representative
                                <li><tt>PAD</tt> - Padding bytes
                                <li><tt>MARK</tt> - Steganographic mark
                            </ul>

                            <p>The message authentication is:
                            <p>&emsp; <tt>HMAC-SHA256-128(serverIdentity | NodeID, REPR | PAD | MARK | E)</tt>
                            <ul>
                                <li><tt>E</tt> - string representation of the number of hours since the UNIX epoch
                            </ul>
                            <p> The inclusion of the time stamp in the HMAC makes it so that the server only ever
                                accepts a given handshake message sent within a controlled number of hours. The server
                                can then keep a record of the client public keys and handshakes that it has seen
                                within that time window to prevent replay attacks.
                            <p>To produce this hmac value in python the code block in the above <tt>Steganographic Mark</tt>
                                block can be used with the <tt>msg</tt> variable set to the entire handshake message
                                with the appended epoch string value.
                        </div>
                    </span>


                </span>
            </div>
        </div>

        <!-- Server Session Key Generation -->
        <div class="rec-outer">
            <div class="calculation server">
                <div class="rec-label">Server Session Key Generation</div>
                <img class="illustration" src="images/key4.png" width="106" height="250" />
                <div class="rec-explanation">
                    <p>The server generates a private/public keypair
                        for key exchange. Key exchange is a technique
                        where two parties can agree on the same number without
                        an eavesdropper being able to tell what it is.
                    <p>
                        An explanation of the key exchange can be found on
                        <a href="https://x25519.xargs.org/">https://x25519.xargs.org</a>,
                        but doesn't need to be understood in depth for the rest
                        of this page.
                    <p>
                        The private key is chosen by selecting an integer between
                        0 and 2<sup>256</sup>-1. The server does this by generating 32
                        bytes (256 bits) of random data. The
                        <a href="files/server-ephemeral-private.key" download="server-ephemeral-private.key">private
                            key</a>
                        selected is:

                    <pre class="ind2"><tt class="longboi"
    >909192939495969798999a9b9c9d9e9fa0a1a2a3a4a5a6a7a8a9aaabacadaeaf</tt></pre>

                    The <a href="files/server-ephemeral-public.key" download="server-ephemeral-public.key">public
                        key</a>
                    is created from the private key as explained on <a
                        href="https://x25519.xargs.org/">https://x25519.xargs.org</a>.
                    The public key calculated is:

                    <pre class="ind2"><tt class="longboi"
    >9fd7ad6dcff4298dd3f96d5b1b2af910a0535b1488d7f8fabb349a982880b615</tt></pre>

                    The public key calculation can be confirmed at the command line:
                    <codesample>
                        <pre><code>### requires openssl 1.1.0 or higher
$ openssl pkey -noout -text &lt; server-ephemeral-private.key

X25519 Private-Key:
priv:
    90:91:92:93:94:95:96:97:98:99:9a:9b:9c:9d:9e:
    9f:a0:a1:a2:a3:a4:a5:a6:a7:a8:a9:aa:ab:ac:ad:
    ae:af
pub:
    9f:d7:ad:6d:cf:f4:29:8d:d3:f9:6d:5b:1b:2a:f9:
    10:a0:53:5b:14:88:d7:f8:fa:bb:34:9a:98:28:80:
    b6:15
</code></pre>
                    </codesample>
                </div>
            </div>
        </div>

        <!-- Server Session Secrets Calc -->
        <div class="rec-outer">
            <div class="calculation server">
                <div class="rec-label">Server Session Secrets Calc</div>
                <img class="illustration" src="images/key9.png" width="97" height="250" />
                <div class="rec-explanation">
                    The server now has the information to calculate the
                    keys used to encrypt the rest of the handshake. It uses the following
                    information in this calculation:
                    <ul>
                        <li><a href="files/client-ephemeral-public.key">client public key</a> (from Client Hello)
                        <li><a href="files/server-ephemeral-private.key">server private key</a> (from Server Key
                            Exchange Generation)
                        <li>SHA384 hash of ClientHello and ServerHello</li>
                    </ul>
                    First, the server finds the shared secret, which is the
                    result of the key exchange that allows the client and server
                    to agree on a number. The server multiplies the client's
                    public key by the server's private key using the curve25519()
                    algorithm. The 32-byte result is found to be:
                    <pre class="ind2"><tt class="longboi"
        >df4a291baa1eb7cfa6934b29b474baad2697e29f1f920dcc77c8a0a088447624</tt></pre>

                    I've provided <a href="files/curve25519-mult.c" download="curve25519-mult.c">a tool</a>
                    to perform this calculation:
                    <codesample>
                        <pre><code>$ cc -o curve25519-mult curve25519-mult.c
    $ ./curve25519-mult server-ephemeral-private.key \
                        client-ephemeral-public.key | hexdump

    0000000 df 4a 29 1b aa 1e b7 cf a6 93 4b 29 b4 74 ba ad
    0000010 26 97 e2 9f 1f 92 0d cc 77 c8 a0 a0 88 44 76 24
    </code></pre>
                    </codesample>

                    We then calculate the SHA384 hash of all handshake messages
                    to this point (ClientHello and ServerHello). The hash does
                    not include the 5-byte "record" headers. This "hello_hash"
                    is <tt
                        class="longboi">e05f64fcd082bdb0dce473adf669c2769f257a1c75a51b7887468b5e0e7a7de4f4d34555112077f16e079019d5a845bd</tt>:
                    <codesample>
                        <pre><code>$ (tail -c +6 clienthello; tail -c +6 serverhello) | openssl sha384
    e05f64fcd082bdb0dce473adf669c2769f257a1c75a51b7887468b5e0e7a7de4f4d34555112077f16e079019d5a845bd
    </code></pre>
                    </codesample>

                    We then feed the hash and the shared secret into a set of
                    key derivation operations, designed to ensure the integrity
                    of the handshake process and to protect against known and
                    possible attacks:

                    <processblock>
                        <pre>early_secret = HKDF-Extract(salt: 00, key: 00...)
    empty_hash = SHA384("")
    derived_secret = HKDF-Expand-Label(key: early_secret, label: "derived", ctx: empty_hash, len: 48)
    handshake_secret = HKDF-Extract(salt: derived_secret, key: shared_secret)
    client_secret = HKDF-Expand-Label(key: handshake_secret, label: "c hs traffic", ctx: hello_hash, len: 48)
    server_secret = HKDF-Expand-Label(key: handshake_secret, label: "s hs traffic", ctx: hello_hash, len: 48)
    client_handshake_key = HKDF-Expand-Label(key: client_secret, label: "key", ctx: "", len: 32)
    server_handshake_key = HKDF-Expand-Label(key: server_secret, label: "key", ctx: "", len: 32)
    client_handshake_iv = HKDF-Expand-Label(key: client_secret, label: "iv", ctx: "", len: 12)
    server_handshake_iv = HKDF-Expand-Label(key: server_secret, label: "iv", ctx: "", len: 12)
    </pre>
                    </processblock>

                    This has introduced two new cryptographic methods:
                    <ul>
                        <li><tt>HKDF-Extract</tt> - given a salt and some bytes of key material
                            create 384 bits (48 bytes) of new key material, with the
                            input key material's entropy evenly distributed in the
                            output.
                        <li><tt>HKDF-Expand-Label</tt> - given the inputs of key
                            material, label, and context data, create a new key of the
                            requested length.
                    </ul>

                    I've created <a href="files/hkdf-384.sh" download="hkdf-384">an HKDF tool</a>
                    to perform these operations on the command line.
                    <codesample>
                        <pre><code>$ hello_hash=e05f64fcd082bdb0dce473adf669c2769f257a1c75a51b7887468b5e0e7a7de4f4d34555112077f16e079019d5a845bd
    $ shared_secret=df4a291baa1eb7cfa6934b29b474baad2697e29f1f920dcc77c8a0a088447624
    $ zero_key=000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    $ early_secret=$(./hkdf-384 extract 00 $zero_key)
    $ empty_hash=$(openssl sha384 < /dev/null | sed -e 's/.* //')
    $ derived_secret=$(./hkdf-384 expandlabel $early_secret "derived" $empty_hash 48)
    $ handshake_secret=$(./hkdf-384 extract $derived_secret $shared_secret)
    $ csecret=$(./hkdf-384 expandlabel $handshake_secret "c hs traffic" $hello_hash 48)
    $ ssecret=$(./hkdf-384 expandlabel $handshake_secret "s hs traffic" $hello_hash 48)
    $ client_handshake_key=$(./hkdf-384 expandlabel $csecret "key" "" 32)
    $ server_handshake_key=$(./hkdf-384 expandlabel $ssecret "key" "" 32)
    $ client_handshake_iv=$(./hkdf-384 expandlabel $csecret "iv" "" 12)
    $ server_handshake_iv=$(./hkdf-384 expandlabel $ssecret "iv" "" 12)
    $ echo hssec: $handshake_secret
    $ echo ssec: $ssecret
    $ echo csec: $csecret
    $ echo skey: $server_handshake_key
    $ echo siv: $server_handshake_iv
    $ echo ckey: $client_handshake_key
    $ echo civ: $client_handshake_iv

    hssec: bdbbe8757494bef20de932598294ea65b5e6bf6dc5c02a960a2de2eaa9b07c929078d2caa0936231c38d1725f179d299
    ssec: 23323da031634b241dd37d61032b62a4f450584d1f7f47983ba2f7cc0cdcc39a68f481f2b019f9403a3051908a5d1622
    csec: db89d2d6df0e84fed74a2288f8fd4d0959f790ff23946cdf4c26d85e51bebd42ae184501972f8d30c4a3e4a3693d0ef0
    skey: 9f13575ce3f8cfc1df64a77ceaffe89700b492ad31b4fab01c4792be1b266b7f
    siv: 9563bc8b590f671f488d2da3
    ckey: 1135b4826a9a70257e5a391ad93093dfd7c4214812f493b3e3daae1eb2b1ac69
    civ: 4256d2e0e88babdd05eb2f27
    </code></pre>
                    </codesample>

                    From this we get the following key data:
                    <ul>
                        <li>handshake secret: <tt
                                class="longboi">bdbbe8757494bef20de932598294ea65b5e6bf6dc5c02a960a2de2eaa9b07c929078d2caa0936231c38d1725f179d299</tt>
                        <li>server handshake traffic secret: <tt
                                class="longboi">23323da031634b241dd37d61032b62a4f450584d1f7f47983ba2f7cc0cdcc39a68f481f2b019f9403a3051908a5d1622</tt>.
                        <li>client handshake traffic secret: <tt
                                class="longboi">db89d2d6df0e84fed74a2288f8fd4d0959f790ff23946cdf4c26d85e51bebd42ae184501972f8d30c4a3e4a3693d0ef0</tt>.
                        <li>server handshake key: <tt
                                class="longboi">9f13575ce3f8cfc1df64a77ceaffe89700b492ad31b4fab01c4792be1b266b7f</tt>
                        <li>server handshake IV: <tt class="longboi">9563bc8b590f671f488d2da3</tt>
                        <li>client handshake key: <tt
                                class="longboi">1135b4826a9a70257e5a391ad93093dfd7c4214812f493b3e3daae1eb2b1ac69</tt>
                        <li>client handshake IV: <tt class="longboi">4256d2e0e88babdd05eb2f27</tt>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Server Handshake -->
        <div class="rec-outer">
            <div class="record server">
                <div class="rec-label">Server Handshake</div>
                <img class="illustration" src="images/key2.png" width="124" height="250" />
                <div class="rec-explanation">
                    The server says "Hello" back. The server provides information including the following:
                    <ul>
                        <li>server ephemeral session public key representative
                        <li>obfs4 NTOR handshake authentication
                        <li>padding of random length between 4096 and 8192 bytes.
                        <li>mark indicating that the client knows the servers Node ID
                        <li>MAC value ensuring that the contents of the packet have not been modified.
                        <li>encrypted message containing prng seed for client to use for padding
                    </ul>
                </div>
                <span class="record-data">
                    <span class="string">
                        <span class="label">Elligator2 Encoded Public Representative</span>
                        <span class="bytes">
                            TODO: Add Server Representative
                        </span>
                        <div class="explanation">
                            Each handshake message starts with the client's x255519 public key encoded using
                            the Elligator2 encoding scheme.
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Obfs4 NTOR Handshake Authentication</span>
                        <span class="bytes">
                            TODO: NTOR Authentication value from Server Secrets Calc
                        </span>
                        <div class="explanation">
                            Each handshake message starts with the client's x255519 public key encoded using
                            the Elligator2 encoding scheme.
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Padding</span>
                        <span class="bytes padding-short">
                            da 88 ..(4092B).. e4 c3
                        </span>
                        <span class="bytes padding-long" style="display: hide;">
                            da 88 54 2c e5 81 71 69 6e f7 01 74 c6 47 fb 7c b9 81 b7 b5 92 9e 29 b3 0d 00 95 d3 64 bf 49 3a c3 f2 be bf 20 5a 2d 21 e1 87 52 2a 5e fc 1d 1c 62 32 bc 03 63 75 db 43 65 4a 3b a8 a2 76 9a 65 79 75 37 e9 81 53 aa 92 d5 50 7c 78 e0 90 6d 69 aa 8e 50 f9 1b ce fc 33 2d fd bd be 46 4c 2a 20 fc 76 95 e4 5b 75 14 23 53 e0 d0 7c cb 2c d5 a0 ac c6 4b 43 ff b8 3d 4f ab c0 da 10 d9 2d cc 5e c3 43 f9 30 f0 a7 8a 34 b0 fa 6f 63 7d 82 0b 71 43 6d ed d7 5c d5 37 da 8a 9a b5 f9 45 3a c4 a5 2f 5c 15 37 4d 48 a7 81 b7 ca 02 05 08 d4 dd 73 bd 66 9a 1d b2 02 cf 50 b5 ab a3 06 7a a1 be 1b cd a5 20 2a dc 59 b4 ca 4e 43 6f 78 cb 57 9f 27 62 6c e1 6a 46 b6 c3 8c 20 9a 5b f0 b9 a8 39 90 fa 71 aa 22 c4 10 76 5b 1a 8d 67 0d 1e 31 cb 16 48 7d 21 de 3a 51 fe 3a 3c 49 ad b9 84 7d a6 69 f0 3b 08 c6 b5 f3 0f 90 48 b8 ac 4e bf e3 a1 14 fa 46 cb c3 9e b3 73 8a c3 eb 5e 17 8d 87 75 66 54 f2 37 9f bf d8 52 4f 4d d7 cb 26 0f 5a ce 56 50 08 28 68 de 30 b9 3d 5d 6a 92 0b bc 1b 0f 53 a8 03 8a 55 82 6f 23 a0 ce d3 ca 56 62 52 53 ff ac f4 5a b8 93 f1 11 db 1f 6f 76 63 c6 e4 d5 8c 37 c4 15 66 40 3d ce 98 a0 fa 22 1d 2a 81 1b b0 62 c8 b1 ce 2d d0 a8 b9 48 f8 67 0c 76 96 42 78 23 45 44 63 51 bb dc cb eb b8 28 39 70 6d e5 7f c6 35 c6 75 05 40 e6 1b 0f 7a e6 4f 13 9f b3 96 c2 ca 2e 7a 31 e1 e5 39 d5 70 a3 b6 4c 7f 79 04 70 63 ee d1 26 93 ac 8d 95 fb c3 fb da 80 0c 7e 42 84 c8 d3 ac cf c6 17 af e0 29 3d 1c 5d e2 0f b2 9f 5f 33 92 36 08 97 34 1d 63 5c e0 6a 66 d0 d1 c7 fb 40 d0 ff 81 89 d1 f2 44 1e 04 74 a4 12 bb 22 09 0a 8d dc 90 a7 bf 30 09 70 a5 0f 44 11 00 2a 91 4c d4 70 68 b7 62 e5 cd ab d6 f1 0c 3f 54 ac 80 5c d1 a6 16 2d 98 17 a3 e5 5b 4c cc 31 9f 33 28 28 c3 84 35 06 88 a4 48 8f e4 60 39 7b 5c c8 09 db 56 75 68 74 16 c8 18 38 aa b5 09 bb 22 0f 55 ad 98 2a 3e 56 f7 60 99 52 df f4 cb 57 00 89 af db a3 4b 7e 7c e0 37 9b b3 cc 0e 18 d7 37 4d 95 66 15 76 0f 6e eb dd 68 8b 91 25 be c0 f0 05 54 69 8f 18 8b 5d c2 1a 82 03 db 97 8a 62 d7 38 cc 5b da c8 21 03 81 b6 0a 30 78 dd 53 44 41 28 32 8e 15 f7 92 d1 3b 3c 90 cc e2 e5 cc 71 d0 c3 bb 54 45 71 50 6f e1 3c b6 db e5 cc 9c 3d 4d b6 07 f1 49 e9 db a6 b0 2a ab 96 4c ab a0 72 a8 8d 26 4d 58 a3 d3 60 7b e1 d6 c5 d1 5d 7c 1d 42 ed 30 9a 60 dd b8 90 0b 18 5f f6 f9 ec 7f e3 6e cf 70 fd 62 d6 87 5e e7 df eb 84 42 74 88 cd 12 48 ad 0b 18 16 e3 a1 e8 20 19 79 57 f3 64 2b cb 30 6b 89 ab 0b 14 67 37 61 9a 3e 96 45 de 6a 7b b5 78 78 18 02 9b 4e e0 93 48 34 ce 2c b2 cd 6f 4c 6b 65 10 47 cd b5 94 27 27 f2 d6 76 a5 da 7d df 7c d1 88 96 1d e2 08 29 dc 45 5e b8 09 f2 e5 b6 b6 37 f4 d6 95 99 d4 86 02 0d 7f 7e fa 6e e7 52 05 72 47 28 d9 5a bc 5f f7 d8 d7 5c 2d 13 90 cf 86 a9 07 e4 50 d7 5f ce c2 39 1f 1a 45 83 2d bb 3f 23 d8 06 e8 f3 ef 60 54 99 32 43 f9 27 78 98 02 c4 2c 70 db 60 e5 af 0e f0 f9 48 3c bd a4 4a eb 69 e9 3e 16 c9 2c 30 8b af ac 1d 90 95 75 eb 7f 7f bd a4 2c a0 ce 88 77 d3 cd 88 f6 0c a4 1c e9 39 64 38 cc 16 9e 77 29 04 62 8e 13 ea 8d 34 f7 de 02 7d 93 37 a0 9f 4b 9d f0 18 c4 dd cd 73 31 c6 1c 6f be e0 2e e1 15 8c 71 04 73 f1 eb dc e1 28 61 1d f6 6a 5f 8d ff 7e a3 70 e6 e4 d1 f0 56 a2 1e c6 05 fb 10 1a 34 e3 e7 24 1a ee 53 bb 3d 9a b7 75 80 f6 9b 1e 92 d0 6a f6 a7 a5 17 7e db 7c 92 d9 93 45 e4 f4 39 33 a5 f9 22 b6 16 82 0b ac 21 dc 23 9f 1a ca 16 a7 bd ba ec a6 32 f1 20 b4 7b c6 79 55 85 30 e5 7c ba ae d5 bf 4c 9d 7c c2 36 45 14 4e a6 64 44 f8 f6 c4 8a d8 1e f6 13 df 35 03 f4 ee d3 28 ab 52 a4 06 cf f0 e0 0a 9b 9c 45 93 7f f1 79 13 76 49 2f 1e 02 7c a5 95 8f 17 93 2d 02 36 9b 63 2e f2 66 83 2a 4a 2e 1e 90 8d 45 ea ff ed bc c7 07 04 d5 0c 39 15 0b ac 88 9c 15 27 32 dc a3 7b 87 50 7b 06 af f2 36 38 1b 93 e3 7c 6c e4 5a be aa e8 ab 05 95 d8 99 d5 b0 6c 40 ad 23 91 07 15 e4 30 4d 4a 38 9d 2e 2f 06 e1 a2 42 9f 24 78 35 b1 e5 65 65 39 48 c2 ab 8f 54 f8 54 78 dd 63 ec e0 4a 13 d8 75 de 91 3f fb d7 a9 9f 70 13 5f f5 7c d3 9d ca 76 9c 81 14 d9 34 ee cd 7a 3f df ee 59 c4 e2 4d 5b 88 d5 2e f3 8e 88 dd f1 3e 6a c4 39 cb 7d d9 e6 97 85 9a b4 08 b4 df ed 66 fd 02 64 86 c9 3e 7c 8b db 70 93 6b 40 74 75 06 b4 a4 7e 10 8b 62 2b 35 cc 79 66 9e ac 94 1c 4f 5d 60 a4 f6 b1 e5 86 3b 49 7c 81 73 02 6a 6c c7 eb 86 d5 dc a9 e1 bf 84 0b 38 d7 cf aa d0 1d eb 51 2b 0d 58 38 e4 8b 15 9c a5 df 7b 57 5d 4a 95 d6 00 ea a8 28 d0 f9 68 9d de 95 61 7b 50 8c 4e 8f 68 d7 1e e4 db 85 9e 6a 9d 19 4d 70 30 6e 10 3f 55 04 66 10 dd e9 5f a0 eb 79 a9 77 ad 42 27 92 3a 98 f5 d2 6d ff 1f 85 59 02 3c 97 8e 8f 80 d2 9d ff 6c 9a 72 e5 e1 fc 4a 0d 30 d3 bd 21 c2 f4 25 a2 75 5e 07 0d cc 7d 8a 4f 16 eb aa c6 7a 5f 23 90 c3 39 9b f1 1c 17 8b fd 04 64 0b a8 93 5a 00 e6 59 6b 38 89 d3 c2 47 3d cb 7a 22 0f 59 e0 ba 97 13 26 d9 f8 d8 58 bd cc 0c dc 9c 92 ac de f6 10 18 4c 56 ec 2a d0 98 e5 0e 02 26 11 9b ad 0f fd 61 d8 ba a0 19 f1 67 73 53 92 bb 48 f6 d5 bc f4 0d e7 1a bd 53 f4 57 c1 2d c6 55 00 ec d7 46 19 9b a0 0e eb e7 a7 7d f8 5c 81 9b 25 1c 6d 78 c4 fc 35 e2 68 a1 bf c0 1b 94 60 09 11 d2 dc e2 af 06 24 7f d1 4f ba 65 37 e0 7e 0f 01 3a 59 72 c4 2b 7d 4d 6d 8b 5c ba cc 41 2f 9c df b7 7b 0f f9 3c 27 1e 49 5e 50 4d 3b 9d 0c 8c 96 5b cd ef aa eb dd a9 27 1b 1b 5f 34 9a e6 91 a5 75 43 9a e3 32 8b da b5 1d 08 ab 41 db fb 08 11 b7 8d 20 22 ce ef 1f 85 b6 8b a3 3f 86 45 06 76 5f c6 8b 1f 29 00 dd 0a 81 6a 99 0f e4 90 bc 37 61 30 4e fb a9 2d f2 16 67 76 c7 a0 4d b7 d0 8f 8f 38 ff 9e 24 81 f3 f0 5e 9a c4 1f 0d 70 d9 f5 17 bc 1b 2e f9 e9 24 35 34 51 a0 93 41 99 eb 0b 00 f5 fd 4a e3 df 76 c5 d7 92 07 37 9b b3 c5 65 c1 62 15 94 a1 16 45 88 f4 c3 18 28 91 c0 50 c9 06 b6 a0 fe 67 13 92 41 12 e6 41 b1 1c e6 c6 a5 06 d5 a8 e2 c8 15 a6 53 f6 42 ca 6c 01 43 83 31 b2 92 97 ee dc 1d 82 50 9f 92 db 11 12 61 24 0b 9c 24 f1 04 eb 73 a2 3f 5d 04 72 ea d5 23 93 f2 d7 da bc 0f a1 95 02 93 0b 75 3f cc c3 55 5b b9 3c d5 e9 e1 9a d6 e6 92 32 1e 30 1f 1a 95 f9 7b 80 f3 40 86 2d 10 68 29 3c 47 dc 93 40 fd 28 8a 1d 79 e8 88 6e 25 0b 13 6a 1b 63 35 b5 b8 eb bd 70 7d 20 66 a5 3b 3a 81 18 52 81 bb ea e7 80 5d ca da 9f a9 1b a5 56 e6 55 82 15 d8 a3 aa a0 da c7 ac 7a 8d 2d 28 1a de ac 11 22 15 ca a1 25 91 13 4f 75 af c9 f5 10 2f 1c 6c 4d 6c de 17 53 83 ff c0 eb e5 60 b4 e1 4a 4c d5 b9 68 83 b0 fb 75 d0 e1 29 c2 d1 75 0c c1 d1 96 cf 1a 2e 35 c2 fc 82 01 7e d8 83 e0 08 d7 dc a2 46 9c 82 bc da af 3b 42 9e 1d 97 41 a8 f5 0d 18 a8 96 34 0f a1 4f 33 a0 ad 6c 56 25 ae 64 a3 51 b0 12 df c1 cb cd a7 7a b8 d6 92 e9 7f 56 7d 83 3f c8 53 16 73 eb fd 6f 78 c9 91 05 3c 51 a4 b1 28 b4 ae a7 ee ce b6 3d 2f ea dc b4 2e f9 06 5d 73 5d 33 12 ce 1b ed 8d ec 23 5f 4b c3 97 31 c7 c5 d6 8f fa b9 38 15 43 c3 b5 58 10 a3 2e fd c4 5d cc c4 42 59 f3 fe 2d b8 69 72 43 86 b4 6d cc ae b2 3d 9f 1b 21 0c a2 23 c7 61 1e a9 59 7a 8e e3 6c 9d 1e 2d 1d 0d fb f3 37 0c b4 be da cc 38 cd 69 4b a2 0b 69 c4 0d b1 82 c1 5c 5f 7f c6 9a 37 22 df 5b d8 04 91 93 28 4f db 22 06 ba fc f1 f2 71 40 55 f5 64 3a ce 2c 6f 9d 2b bc c6 dd 95 0b 01 10 98 19 3a 9b 3f da 0f d8 c0 41 40 7e be 6a 8b bd 02 a6 92 d5 a6 b2 57 dc 22 59 43 00 53 09 58 a6 e6 5c 52 90 65 d5 36 26 d0 c6 81 5c 57 b8 7a 20 45 f9 1d 83 72 bd 63 46 e1 8c 33 d0 df 98 3d 2b bb 99 34 e5 e2 29 4c d4 c1 73 20 8a 77 e1 d0 33 fb 9c b1 82 d0 87 7c ea c9 fc 24 e9 82 c7 b9 42 a6 2d fa 1b e2 62 d7 eb c3 cf 71 04 52 e7 c2 d9 81 08 9c d4 b6 d6 0a 4d 24 bd 45 83 19 65 10 2c 8f b3 6e f8 80 b5 17 98 b9 68 41 0b 7b 9e 72 b9 87 d2 ea c0 5e fa 48 07 9e 12 af ee 42 b9 88 08 13 b4 42 54 8b dc 24 55 b9 64 b7 60 94 db 8a 9a 7f 9a 86 01 b3 21 34 26 c1 03 87 2e 53 9b 8a 85 a3 95 42 06 aa c7 57 77 e4 e5 bf e1 3c d8 5d 7d 96 22 7d e6 2b cb 74 1b 70 77 ed 4c 69 3b 6b 1e 5a 2a 67 48 06 9e 99 7c 8a 18 da 4e fa 74 e3 53 d2 5e 84 15 51 35 77 70 f4 b9 0c 58 b0 0f 93 4a 28 55 28 ae 11 b1 2c f9 c6 10 57 58 e0 e3 a1 4c 3a b4 c2 81 03 d5 a0 72 db a2 cc 36 d0 66 48 8e 6a b8 c5 b9 d9 db 4d f6 25 a5 33 5c 1f 86 10 54 15 5c b3 07 9e 6d 27 8b 25 7d a0 a3 10 19 94 17 13 2b 61 f2 bc 6c d7 28 19 04 c1 61 ab d8 5a 31 e9 9e 6a 52 4e da 39 d2 15 85 a2 f8 8f 6c fc 4b d2 ca b6 2b 15 b6 92 ee cc b4 f8 54 5d 57 51 28 58 31 78 0a bc f7 2e 3d 46 6a 44 c2 9d ee a4 ae 92 9a a4 dc ec 2e 6c 9f 72 82 e7 0d bc 77 00 85 6f 2e 0d 4f 8e 74 80 05 f9 c3 62 04 1e 98 22 b3 bc d3 e7 6c fa c5 84 56 b2 fe aa aa 06 91 53 93 c2 2e ac 6e 41 6d 97 e3 7a 0c 1c 2f 1e a8 31 50 ca 10 bb 8d fb 08 43 0e 2b 9f 3c b1 36 13 da 00 73 ac a1 7b b2 b4 8d f3 10 db ed 80 61 de 8a f9 4a b3 3c 2c 76 05 87 b6 ae 76 5e a7 b2 f6 fd df 73 b0 e2 0f 33 dd 32 49 d7 03 c4 40 a4 72 56 8b 3e 22 8f c6 fb 54 32 5d f3 09 00 83 38 fc bc 1e 16 df 17 e6 5a d1 8f 68 3a aa c3 2c 9c af 6d cf 84 19 5b 91 d6 40 cd d4 67 32 4f 65 b5 22 99 23 5c 81 6e 9e f9 82 71 7e 83 11 31 cd 2a 0c e4 d6 9d 74 c7 b0 03 3a c2 96 10 fa 49 83 c4 b2 c7 19 88 5b 35 67 21 41 28 5d 58 06 f7 ff 5e 27 7b c4 aa 82 ba 75 f6 1e d7 5f a1 88 cb e6 26 ed 65 ca 0d 21 8f 31 69 5e 14 cb 77 98 4e 3f 71 f2 bb ac fa 17 3b 0f 6d 7b 7a 03 74 49 60 a8 3e 58 dd aa 92 6d 66 09 a2 fe 4b 27 30 30 48 98 66 73 bd 6d 68 f2 1c f0 84 97 a3 10 de 86 2d 26 06 61 8c fe 23 e1 98 90 00 26 e7 88 86 0a 6c 63 2f 40 7c 45 ff c4 05 12 4b 52 30 e9 6f 20 80 d6 c7 c4 cf d2 98 2e d6 6a fa 91 e9 90 63 ce 21 ba ea 70 03 40 32 62 53 04 a7 4e 35 7c b5 4b 47 27 b4 83 94 61 17 10 75 09 34 86 5b fa 1d 34 68 df 5b ae 21 09 cb 84 12 fd 96 54 58 87 52 aa ad 00 df d7 07 45 2e 4e 4c 78 8e 16 f6 93 6f 4d 7a 9e 01 01 4b ba 30 30 ea 9c 98 f6 7f 20 f9 ae 07 63 6f 42 dc 06 2b ec 51 be f0 d4 8d 24 ca 11 45 7e a6 60 e9 09 f6 49 10 a4 59 10 1d f8 d2 b9 ee bd e4 11 8f e3 17 eb ae 0a ae 28 83 b5 96 a5 d0 87 13 df 81 db 1f 52 8f 57 c5 e7 42 ec 2a 65 ab 8f 98 c8 f5 fd ee d6 db 61 20 0b 41 27 9a c1 94 f5 8b da 1d 52 d0 bb 37 e2 39 79 54 35 33 8b 24 15 97 cb c0 f1 75 b8 18 d8 f6 69 b8 3c 49 7e 8c e0 2f bc 04 79 58 76 90 8a ee ac 52 87 f1 39 ef 21 9b 78 7d a2 60 c6 32 33 9c 2d 5f 2f 0d 0a f4 e0 c1 7d d7 83 1f 36 ee 98 3f 4c 71 b5 ee 95 66 4e 7b 61 8c e7 c8 ca de 87 2f 66 f1 06 31 62 8b b9 7e 3d 22 c4 c6 58 9e 3e ec a3 f0 3b ea b6 ce 36 c8 ab 81 1e 8a dd 28 cd d6 33 1f d4 30 b0 4c e5 c4 07 57 ab ec 3b 66 61 e3 34 3f ee 46 81 80 5b 90 89 49 d0 49 19 f2 b1 20 1a 62 5c 2d 6c 42 6f 31 a2 d1 60 b3 25 c4 db c8 69 2f 21 62 95 4c 4c 4b 6d 3f ea 74 3a 02 1c 3d 40 39 7a e0 30 6c 14 02 67 50 04 90 d1 b7 2c fc ba d5 15 d8 e6 4c dc 89 1d 08 2a 18 07 9e a7 a6 a0 a9 05 d3 ea 02 0c ae c1 1e cf 3e 85 7c 04 cd 31 a3 b0 67 78 b3 c2 66 17 d1 ea e8 a7 57 a4 75 65 9a bd 01 b7 db 2b 73 d0 37 ed 3b ee 36 89 3f 01 68 97 9b 89 83 25 b0 56 10 1d bb 76 1a 16 9e 3a a5 40 6a 08 de a9 73 cf 8b c3 77 f9 72 7d 74 5b b6 62 df ef c9 59 01 d8 c4 14 71 ad e3 00 4c a5 7c 87 d4 b7 78 f0 c2 00 04 26 55 55 cb be 15 0a 60 21 5a 4c 1b 52 c0 97 6d 49 9f 4b 2a c6 ab 52 74 bb e5 ef e1 47 f6 ee ac 49 05 27 d6 e2 d3 1e a8 c3 49 36 6c d4 a4 c7 f4 ed d6 ba 25 cd 19 e4 6f c8 31 c1 58 9e 90 2b 77 66 e6 08 1f f7 09 fc 7d a6 f6 13 49 38 aa 58 aa b3 6c 01 1d a6 66 29 c8 f9 32 02 35 40 f7 7a 99 de f4 6c d6 f4 93 39 e2 98 76 23 d3 81 4b 71 72 e4 19 c0 56 ff 31 47 39 89 71 92 2b 96 44 11 d2 0e 4f 77 c2 09 4c b0 4b bb 8c c7 eb ea 70 e8 64 cb f7 80 80 a7 00 1a bc c7 3a da 64 b9 28 2e f8 3e 02 03 20 5e dd 4f a2 23 4b 37 ac 3b 1a 68 7e c7 f2 b6 91 83 17 9a 45 87 5b 7b e8 85 00 ca 7e 23 88 02 a4 8f 88 37 a9 c4 ed 55 20 a1 7d cf 95 97 92 92 93 19 63 ab e1 ac 4e 7b 87 ca ec a3 0d 6e dc 90 76 16 1d 8d 67 04 b9 23 b5 02 e0 4d ff 87 06 2b f0 7f 51 58 91 94 38 9c 54 45 0f 82 0d 54 68 f7 39 f1 cf 0c f2 e0 c7 3f b6 50 79 19 1a 66 e7 5d e4 a7 25 a2 a7 ef 14 d9 7e 10 3f 8d 25 ab 4c 76 9e 83 d8 f7 d1 37 87 d9 70 3b 1e 02 2c 96 dd 87 e9 c5 57 84 de ab 44 d7 19 8d a8 29 55 d6 32 4c 16 9e 85 38 a9 94 77 92 f3 bd 7a e8 24 fa 3d c4 d6 89 01 77 99 7f a0 ea db 03 13 45 fe 40 e4 6c 23 59 35 32 f8 5b 0d 82 9e 94 0e 21 75 05 23 e1 d6 85 47 47 cf f3 ae f5 7c 4c ad bf 10 0c e2 a8 d0 06 cc 20 6d 98 3b 60 f7 71 a2 11 a8 76 1c 51 ef 99 8c aa b9 6d d9 88 45 22 fd d9 6f 97 53 53 b0 7e a8 12 22 4b 49 6a 5a 02 ea ee a6 35 17 9d 80 de 8d a3 2e ba e7 ae a4 b9 5b 34 92 13 72 b0 3e 0c e9 2f 49 92 d8 18 d0 a6 ec 33 e5 1a bc d0 3e 39 77 ed 46 38 f1 ca b7 99 c2 93 94 e6 e9 09 97 d3 7e eb fa f0 20 ab 30 e8 86 81 84 93 4f c6 19 06 7d e2 8b b9 4b 1e b7 da 0b 62 41 e9 46 a4 21 f2 34 12 91 99 65 b8 b5 5e 5a 13 bf 17 c2 3c 36 c5 c3 db 9f 78 a9 06 87 84 a3 ae 2a 90 30 d6 f3 b6 08 a6 9a 47 4f 77 02 b0 7a 87 cd c8 97 53 99 5b d3 75 a2 02 12 b8 2a bd 9f 98 b5 ca a9 c3 c3 f8 31 87 5a 26 51 2b 2d d6 7f 09 ac 71 f9 8e 23 60 6e fd 67 85 49 af 94 0a 4c a3 73 af 32 32 af 57 86 7b 22 9e b3 90 46 0f 5c bf 90 17 b1 25 b2 2d dd b9 a7 07 61 de e4 c3
                        </span>
                        <div class="explanation">
                            In obfs4 the client pads the handshake message with random bytes to a length between
                            4096 and 8192 bytes. This padding is used to make the handshake message a non-uniform
                            length such that the size of the first packet would be a strong indication of the
                            specific protocol being used.
                            <ul>
                                <li><tt>da 88 ... e4 c3</tt> - bytes drawn form prng source.
                            </ul>
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Steganographic Mark</span>
                        <span class="bytes">
                            TODO: compute mark
                        </span>
                        <div class="explanation">
                            As the obfs4 handshake is (ideally) indistinguishable from uniform random bytes,
                            the client includes a steganographic mark in the handshake message to securely
                            indicate that it wishes to establish a connection. The mark is an HMAC that
                            uses the server's public key and node ID as hte key and
                            the client's ephemeral public key as the message. While the HMAC-SHA256 would
                            usually result in 32 bytes, only the first 16 bytes are used for the mark.

                            <p></br>&emsp;<tt>HMAC-SHA256-128(ServerPubkey | NodeID, REPR)</tt>

                            <p>where:
                                <ul>
                                    <li><tt>ServerPubkey</tt> - The obfs4 servers 32 byte public x25519 identity key
                                    <li><tt>NodeID</tt> - The obfs4 servers 20 byte identifier value
                                    <li><tt>REPR</tt> - The clients Elligator2 encoded public key representative
                                </ul>
    

                            <p>Python sample code to produce the hmac value:

                            <pre><code>import hmac
import hashlib

server_pubkey = b'\x9f\xd7\xad\x6d\xcf\xf4\x29\x8d\xd3\xf9\x6d\x5b\x1b\x2a\xf9\x10\xa0\x53\x5b\x14\x88\xd7\xf8\xfa\xbb\x34\x9a\x98\x28\x80\xb6\x15'
node_id = b''
hmac_key = server_pubkey + node_id
msg = b''
h = hmac.new( hmac_key, msg, hashlib.sha256 )
digest = h.hexdigest()
print( digest[:len(digest)/2] )
</code></pre>
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Message Authentication</span>
                        <span class="bytes">
                            TODO: Compute MAC
                        </span>
                        <div class="explanation">
                            In order to ensure that the contents of the handshake message have not been
                            tampered with in transit, the client includes a second HMAC value using the same
                            key as the steganographic mark, but covering the contents of the entire handshake
                            message.

                            Again the HMAC-SHA256 value is truncated to 16 bytes.

                            <p> If we consider the handshake so far to be <tt>[ REPR | PAD | MARK ]</tt> where:
                            <ul>
                                <li><tt>REPR</tt> - The clients Elligator2 encoded public key representative
                                <li><tt>PAD</tt> - Padding bytes
                                <li><tt>MARK</tt> - Steganographic mark
                            </ul>

                            <p>The message authentication is:
                            <p>&emsp; <tt>HMAC-SHA256-128(serverIdentity | NodeID, REPR | PAD | MARK | E)</tt>
                            <ul>
                                <li><tt>E</tt> - string representation of the number of hours since the UNIX epoch
                            </ul>
                            <p> The inclusion of the time stamp in the HMAC makes it so that the server only ever
                                accepts a given handshake message sent within a controlled number of hours. The server
                                can then keep a record of the client public keys and handshakes that it has seen
                                within that time window to prevent replay attacks.
                            <p>To produce this hmac value in python the code block in the above <tt>Steganographic Mark</tt>
                                block can be used with the <tt>msg</tt> variable set to the entire handshake message
                                with the appended epoch string value.
                        </div>
                    </span>

                    <span class="string encrypted">
                        <span class="label">Encrypted Data</span>
                        <span class="bytes">
                            5c 71 16 0c da 85 f1 44
                        </span>
                        <div class="explanation">
                            This data is encrypted with the server application key.
                            <br /><br />
                            See below for the decrypted data.
                        </div>
                    </span>

                    <div class="decryption">
                        <div class="label">Decryption</div>
                        <div class="explanation">
                            This data is encrypted using the client
                            application key and the client application IV that were
                            generated during the "Client Application Keys
                            Calc" step. The IV will be modified
                            by XOR'ing it by the count of records that
                            have already been encrypted with this key,
                            which in this case is 0. The process also
                            takes as input the 5-byte record header
                            that this record begins with, as authenticated
                            data that must match for the decryption to
                            succeed.
                            <br /><br />
                            Because the <tt>openssl</tt> command line
                            tool does not yet support AEAD ciphers,
                            I've written command line tools to both
                            <a href="files/aes_256_gcm_decrypt.c" download="aes_256_gcm_decrypt.c">decrypt</a>
                            and <a href="files/aes_256_gcm_encrypt.c" download="aes_256_gcm_encrypt.c">encrypt</a>
                            this data.
                            <codesample>
                                <pre><code>### from the "Client Application Keys Calc" step
    $ key=de2f4c7672723a692319873e5c227606691a32d1c59d8b9f51dbb9352e9ca9cc
    $ iv=bb007956f474b25de902432f
    ### from this record
    $ recdata=1703030015
    $ authtag=73aaabf5b82fbf9a2961bcde10038a32
    $ recordnum=0
    ### may need to add -I and -L flags for include and lib dirs
    $ cc -o aes_256_gcm_decrypt aes_256_gcm_decrypt.c -lssl -lcrypto
    $ echo "82 81 39 cb 7b" | xxd -r -p > /tmp/msg3
    $ cat /tmp/msg3 \
      | ./aes_256_gcm_decrypt $iv $recordnum $key $recdata $authtag \
      | hexdump -C

    00000000  70 69 6e 67 17                                    |ping.|
    </code></pre>
                            </codesample>
                        </div>
                    </div>

                    <span class="string decrypted">
                        <span class="label">PRNG Seed Message</span>
                        <span class="bytes">
                            01 00 18 f6 de 0e a1 f2 61 c8 1f bf e8 54 5b 23 91 60 9c 7d 2b fe bc be 45 9e 34
                        </span>
                        <div class="explanation">
                            This message is explained in its own section below.
                        </div>
                    </span>
                </span> <!-- end record-data -->
            </div>
        </div>

        <!-- Length Distribution Seed Message -->
        <div class="rec-outer">
            <div class="record server embedded">
                <div class="rec-label">Length Distribution Seed Message</div>
                <div class="rec-explanation">
                    The server sends a message to the client that will be used
                    to seed the randomized distribution of lengths of lengths
                    for future Frames sent by the client.
                </div>
                <span class="record-data">
                    <span class="string">
                        <span class="label">Message Type: DRBG Length Seed</span>
                        <span class="bytes">
                            01
                        </span>
                        <div class="explanation">
                            A 1-byte message type field. 0x01 = DRBG Length Seed.
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Message Length</span>
                        <span class="bytes">
                            00 18
                        </span>
                        <div class="explanation">
                            2-byte (u16) length field.
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">DRBG Length Seed</span>
                        <span class="bytes">
                            f6 de 0e a1 f2 61 c8 1f bf e8 54 5b 23 91 60 9c 7d 2b fe bc be 45 9e 34
                        </span>
                        <div class="explanation">
                            24 byte seed for the deterministic random bit
                            generator used for selecting random padded frame
                            lengths.
                        </div>
                    </span>
                </span>
            </div>
        </div>

        <!-- Client Session Keys Calc -->
        <div class="rec-outer">
            <div class="calculation client">
                <div class="rec-label">Client Session Keys Calc</div>
                <img class="illustration" src="images/key8.png" width="97" height="250" />
                <div class="rec-explanation">
                    The client now has the information to calculate the
                    keys used to encrypt the rest of the handshake. It uses the following
                    information in this calculation:
                    <ul>
                        <li><a href="files/server-ephemeral-public.key">server public key</a> (from Server Hello)
                        <li><a href="files/client-ephemeral-private.key">client private key</a> (from Client Key
                            Exchange Generation)
                        <li>SHA384 hash of ClientHello and ServerHello</li>
                    </ul>
                    First, the client finds the shared secret, which is the
                    result of the key exchange that allows the client and server
                    to agree on a number. The client multiplies the server's
                    public key by the client's private key using the curve25519()
                    algorithm. The properties of elliptic curve multiplication will
                    cause this to result in the same number found by the server in its
                    multiplication. The 32-byte result is found to be:
                    <pre class="ind2"><tt class="longboi"
    >df4a291baa1eb7cfa6934b29b474baad2697e29f1f920dcc77c8a0a088447624</tt></pre>

                    I've provided <a href="files/curve25519-mult.c" download="curve25519-mult.c">a tool</a>
                    to perform this calculation:
                    <codesample>
                        <pre><code>$ cc -o curve25519-mult curve25519-mult.c
$ ./curve25519-mult client-ephemeral-private.key \
                    server-ephemeral-public.key | hexdump

0000000 df 4a 29 1b aa 1e b7 cf a6 93 4b 29 b4 74 ba ad
0000010 26 97 e2 9f 1f 92 0d cc 77 c8 a0 a0 88 44 76 24
</code></pre>
                    </codesample>
                    Since the shared secret above is the same number calculated by the
                    server in "Server Handshake Keys Calc", the rest of
                    the calculation is identical and the same values are found:
                    <ul>
                        <li>server handshake key: <tt
                                class="longboi">9f13575ce3f8cfc1df64a77ceaffe89700b492ad31b4fab01c4792be1b266b7f</tt>
                        <li>server handshake IV: <tt class="longboi">9563bc8b590f671f488d2da3</tt>
                        <li>client handshake key: <tt
                                class="longboi">1135b4826a9a70257e5a391ad93093dfd7c4214812f493b3e3daae1eb2b1ac69</tt>
                        <li>client handshake IV: <tt class="longboi">4256d2e0e88babdd05eb2f27</tt>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Encrypted Frame -->
        <div class="rec-outer">
            <div class="record client">
                <div class="rec-label">Encrypted Frame</div>
                <div class="rec-explanation">
                    To reduce the fingerprint-ability of the protocol the
                    entire packet is encrypted or obfuscated to be
                    indistinguishable from uniform random. Once the outer frame
                    and encrypted data are decrypted, the inner data can be
                    parsed into one of several Message types, or (\x0x00..) padding.
                    <br /><br />
                    The internal messages are discussed in their own sections below this one.
                </div>
                <span class="record-data">
                    <span class="string encrypted">
                        <span class="label">Obfuscated Frame Length</span>
                        <span class="bytes">
                            fb 15
                        </span>
                        <div class="explanation">
                            Obfs4 Frames begin with a 2-byte length field that
                            is encrypted based on a NaCl secretbox nonce. The
                            length can extend beyond one packet to account for
                            network fragmentation.
                            <br /><br />
                            The data following this length is encrypted obfs4
                            <span class="texttt">Messages</span> as well as padding.
                        </div>
                    </span>

                    <span class="string encrypted">
                        <span class="label">Encrypted Data</span>
                        <span class="bytes">
                            30 a8 06 82 81 39 cb 7b
                        </span>
                        <div class="explanation">
                            This data is encrypted with the client application key.
                            <br /><br />
                            See below for the decrypted data.
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Auth Tag</span>
                        <span class="bytes">
                            73 aa ab f5 b8 2f bf 9a 29 61 bc de 10 03 8a 32
                        </span>
                        <div class="explanation">
                            This is the AEAD authentication tag
                            that protects the integrity of the
                            encrypted data and the record header.
                        </div>
                    </span>

                    <div class="decryption">
                        <div class="label">Decryption</div>
                        <div class="explanation">
                            This data is encrypted using the client
                            application key and the client application IV that were
                            generated during the "Client Application Keys
                            Calc" step. The IV will be modified
                            by XOR'ing it by the count of records that
                            have already been encrypted with this key,
                            which in this case is 0. The process also
                            takes as input the 5-byte record header
                            that this record begins with, as authenticated
                            data that must match for the decryption to
                            succeed.
                            <br /><br />
                            Because the <tt>openssl</tt> command line
                            tool does not yet support AEAD ciphers,
                            I've written command line tools to both
                            <a href="files/aes_256_gcm_decrypt.c" download="aes_256_gcm_decrypt.c">decrypt</a>
                            and <a href="files/aes_256_gcm_encrypt.c" download="aes_256_gcm_encrypt.c">encrypt</a>
                            this data.
                            <codesample>
                                <pre><code>### from the "Client Application Keys Calc" step
    $ key=de2f4c7672723a692319873e5c227606691a32d1c59d8b9f51dbb9352e9ca9cc
    $ iv=bb007956f474b25de902432f
    ### from this record
    $ recdata=1703030015
    $ authtag=73aaabf5b82fbf9a2961bcde10038a32
    $ recordnum=0
    ### may need to add -I and -L flags for include and lib dirs
    $ cc -o aes_256_gcm_decrypt aes_256_gcm_decrypt.c -lssl -lcrypto
    $ echo "82 81 39 cb 7b" | xxd -r -p > /tmp/msg3
    $ cat /tmp/msg3 \
      | ./aes_256_gcm_decrypt $iv $recordnum $key $recdata $authtag \
      | hexdump -C

    00000000  70 69 6e 67 17                                    |ping.|
    </code></pre>
                            </codesample>
                        </div>
                    </div>

                    <span class="string decrypted">
                        <span class="label">Client Payload Message</span>
                        <span class="bytes">
                            00 00 04 70 6f 6e 67
                        </span>
                        <div class="explanation">
                            This application data is represented in its own section below.
                        </div>
                    </span>
                </span>
            </div>
        </div>

        <!-- Client Payload Message -->
        <div class="rec-outer">
            <div class="record client embedded">
                <div class="rec-label">Client Payload Message</div>
                <div class="rec-explanation">
                    The client sends the data "ping".
                </div>
                <span class="record-data">
                    <span class="string">
                        <span class="label">Message Type: Payload</span>
                        <span class="bytes">
                            00
                        </span>
                        <div class="explanation">
                            A 1-byte message type field. 0x00 = data payload.
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Message Length</span>
                        <span class="bytes">
                            00 04
                        </span>
                        <div class="explanation">
                            2-byte (u16) length field.
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Application Data</span>
                        <span class="bytes">
                            70 69 6e 67
                        </span>
                        <div class="explanation">
                            The bytes "ping".
                        </div>
                    </span>
                </span>
            </div>
        </div>

        <!-- Encrypted Frame -->
        <div class="rec-outer">
            <div class="record server">
                <div class="rec-label">Encrypted Frame</div>
                <div class="rec-explanation">
                    To reduce the fingerprint-ability of the protocol the
                    entire packet is encrypted or obfuscated to be
                    indistinguishable from uniform random. Once the outer frame
                    and encrypted data are decrypted, the inner data can be
                    parsed into one of several Message types, or (\x0x00..) padding.
                    <br /><br />
                    The internal messages are discussed in their own sections below this one.
                </div>
                <span class="record-data">
                    <span class="string encrypted">
                        <span class="label">Obfuscated Frame Length</span>
                        <span class="bytes">
                            A6 21
                        </span>
                        <div class="explanation">
                            Obfs4 Frames begin with a 2-byte length field that
                            is encrypted based on a NaCl secretbox nonce. The
                            length can extend beyond one packet to account for
                            network fragmentation.
                            <br /><br />
                            The data following this length is encrypted obfs4
                            <span class="texttt">Messages</span> as well as padding.
                        </div>
                    </span>

                    <span class="string encrypted">
                        <span class="label">Encrypted Data</span>
                        <span class="bytes">
                            5c 71 16 0c da 85 f1 44
                        </span>
                        <div class="explanation">
                            This data is encrypted with the server application key.
                            <br /><br />
                            See below for the decrypted data.
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Auth Tag</span>
                        <span class="bytes">
                            7a e2 3f a6 6d 56 f4 c5 40 84 82 b1 b1 d4 c9 98
                        </span>
                        <div class="explanation">
                            This is the AEAD authentication tag
                            that protects the integrity of the
                            encrypted data and the record header.
                        </div>
                    </span>

                    <div class="decryption">
                        <div class="label">Decryption</div>
                        <div class="explanation">
                            This data is encrypted using the server
                            application key and the server application IV that were
                            generated during the "Server Application Keys
                            Calc" step. The IV will be modified
                            by XOR'ing it by the count of records that
                            have already been encrypted with this key,
                            which in this case is 2. The process also
                            takes as input the 5-byte record header
                            that this record begins with, as authenticated
                            data that must match for the decryption to
                            succeed.
                            <br /><br />
                            Because the <tt>openssl</tt> command line
                            tool does not yet support AEAD ciphers,
                            I've written command line tools to both
                            <a href="files/aes_256_gcm_decrypt.c" download="aes_256_gcm_decrypt.c">decrypt</a>
                            and <a href="files/aes_256_gcm_encrypt.c" download="aes_256_gcm_encrypt.c">encrypt</a>
                            this data.
                            <codesample>
                                <pre><code>### from the "Server Application Keys Calc" step
    $ key=01f78623f17e3edcc09e944027ba3218d57c8e0db93cd3ac419309274700ac27
    $ iv=196a750b0c5049c0cc51a541
    ### from this record
    $ recdata=1703030015
    $ authtag=7ae23fa66d56f4c5408482b1b1d4c998
    $ recordnum=2
    ### may need to add -I and -L flags for include and lib dirs
    $ cc -o aes_256_gcm_decrypt aes_256_gcm_decrypt.c -lssl -lcrypto
    $ echo "0c da 85 f1 44" | xxd -r -p > /tmp/msg4
    $ cat /tmp/msg4 \
      | ./aes_256_gcm_decrypt $iv $recordnum $key $recdata $authtag \
      | hexdump -C

    00000000  70 6f 6e 67 17                                    |pong.|
    </code></pre>
                            </codesample>
                        </div>
                    </div>

                    <span class="string decrypted">
                        <span class="label">Server Payload Message</span>
                        <span class="bytes">
                            00 00 04 70 6f 6e 67
                        </span>
                        <div class="explanation">
                            This application data is represented in its own section below.
                        </div>
                    </span>
                </span>
            </div>
        </div>

        <!-- Server Payload Message -->
        <div class="rec-outer">
            <div class="record server embedded">
                <div class="rec-label">Server Payload Message</div>
                <div class="rec-explanation">
                    The server replies with the data "pong".
                </div>
                <span class="record-data">
                    <span class="string">
                        <span class="label">Message Type: Payload</span>
                        <span class="bytes">
                            00
                        </span>
                        <div class="explanation">
                            A 1-byte message type field. 0x00 = data payload.
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Message Length</span>
                        <span class="bytes">
                            00 04
                        </span>
                        <div class="explanation">
                            2-byte (u16) length field.
                        </div>
                    </span>

                    <span class="string">
                        <span class="label">Application Data</span>
                        <span class="bytes">
                            70 6f 6e 67
                        </span>
                        <div class="explanation">
                            The bytes "pong".
                        </div>
                    </span>
                </span>
            </div>
        </div>

        <!-- /// footer - code link -->
        <div class="outerblock">
            <p>The code for this project can be found
                <a href="https://github.com/jmwample/ptrs/tree/site">on GitHub</a>.
            </p>
        </div>
        <!-- /// footer - inspiration links -->
        <div class="outerblock">
            <p>This page was inspired by the <a href="https://tls13.xargs.org/">TLS 1.X
                    Explained</a> sites and forked from <a href="https://github.com/syncsynchalt/illustrated-tls13">the
                    original
                    source</a>
                written by <a href="https://twitter.com/xargsnotbombs">@XargsNotBombs</a>.</p>
        </div>
    </div>

    <div id="templates" style="display: none">
        <div id="showCodeTmpl">
            <!--suppress JSDeprecatedSymbols -->
            <button class="show-code" onclick="ill.showCode(this, event)">Show Code</button>
        </div>
        <!--suppress JSDeprecatedSymbols -->
        <button id="annotateTmpl" class="annotate-toggle"
            onclick="ill.toggleAnnotate(this.parentElement, event)">Annotations</button>
    </div>

    <!--suppress HtmlUnknownAnchorTarget -->
    <a class="print-mode" href="#print" onclick="ill.printMode()">
        [print]
    </a>
    </div>
</body>

</html>
<!--
    TODO:
        - Description of Encryption / Decryption with example programs
        - Colors and monospace font for "Frames", and "Messages"
        - Add IAT mode modal so it switches the packet lengths / paddings
        - real flow bytes.
-->